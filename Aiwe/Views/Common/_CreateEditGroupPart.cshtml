@using Aibe.Helpers;
@using Aibe.Models.Core;
@using Aibe.Models;
@using Aiwe.Helpers;
@using Aiwe.Models;
@using Aiwe.Models.ViewModels;
@using Aiwe.Extensions;
@using System.Data;
@using Extension.String;

@model AiweCreateEditGroupModel

@{ 
  bool isCreate = Model.ActionType.EqualsIgnoreCase(Aibe.DH.CreateGroupActionName);
}

<div class="form-horizontal">
  @foreach (string identifierColumn in Model.IdentifierColumns) {
    if (!Model.Meta.IsGroupByColumn(identifierColumn)) {
      continue;
    }
    GroupByColumnInfo groupByColumnInfo = Model.Meta.GetGroupByColumn(identifierColumn);
    DataColumn column = Model.Meta.GetDataColumn(identifierColumn);
    string cn = column.ColumnName;
    string dataType = column.DataType.ToString().Substring(Aibe.DH.SharedPrefixDataType.Length);

    //ordered by precedence
    bool isDropDown = Model.Meta.IsCreateEditDropDownColumn(cn);
    bool isTextField = Model.Meta.IsTextField(cn);

    //string controlClasses = "form-control form-control-common-plus";

    if (groupByColumnInfo.IsAutoInt) {
      string dataValue = Model.GetData(cn);
      <input type="hidden" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataValue" />
      continue;
    }

    if (groupByColumnInfo.IsAutoDateTime) {
      string dataValueRaw = Model.GetData(cn);
      DateTime? dataValueDt = string.IsNullOrWhiteSpace(dataValueRaw) ? null : new DateTime?(DateTime.Parse(dataValueRaw));
      string dataDateValue = dataValueDt.HasValue ? dataValueDt.Value.ToString(Aibe.DH.DefaultDateFormat) : string.Empty;
      string dataTimeName = cn + Aibe.DH.CreateEditTimeAppendixName;
      string dataTimeValue = Model.GetTime(dataTimeName, dataValueDt);
      <input type="hidden" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataDateValue" />
      <input type="hidden" name="@dataTimeName" class="@Aiwe.DH.ControlClasses" value="@dataTimeValue" />
      continue;
    }

    if (dataType.EqualsIgnoreCase(Aibe.DH.StringDataType)) { //String type
      string dataValue = Model.GetData(cn);
      if (isCreate && string.IsNullOrWhiteSpace(dataValue)) { //only for create. The edit does not have, only if the previous dataValue is empty
        string prefix = Model.Meta.GetPrefix(cn);
        string postfix = Model.Meta.GetPostfix(cn);
        //according to http://stackoverflow.com/questions/637308/why-is-adding-null-to-a-string-legal
        //The addition of null using + is legal;
        dataValue = prefix + dataValue + postfix;
      }

      if (isDropDown) {
        List<string> dropdowns = Model.Meta.GetStaticCreateEditDropDownFor(cn, dataValue, Aibe.DH.DropDownTextDataType);
        if (dropdowns == null || dropdowns.Count <= 0) {
          <div class="form-group">
            <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
            <div class="@ViewBag.EditorClass">
              <input type="text" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataValue"/>
              @Html.ValidationMessage(cn, new { @class = "text-danger" })
            </div>
          </div>
        } else { //string dropdown case
          <div class="form-group">
            <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
            <div class="@ViewBag.EditorClass">
              <div id="live-dd-@cn" class="live-dd" commondatatype="@Aibe.DH.DropDownTextDataType">
                @{ 
                  List<SelectListItem> dropdownItems = new List<SelectListItem> {
                    new SelectListItem { Text = null, Value = null },
                  };
                  dropdownItems.AddRange(dropdowns.Select(x => new SelectListItem { Text = x, Value = x }).ToArray());
                  SelectListItem item = dropdownItems.FirstOrDefault(x => x.Value == dataValue);
                  if (item != null && !string.IsNullOrWhiteSpace(dataValue)) {
                    item.Selected = true;
                  }
                }
                @Html.DropDownList(cn, dropdownItems, new { @class = Aiwe.DH.ControlClasses + " common-column-dropdown",
                  id = "common-column-dropdown-" + cn })
               </div>
              <input type="text" class="common-column-dropdown-original" id="common-column-dropdown-original-@cn" value="@dataValue" hidden="hidden" />
              @Html.ValidationMessage(cn, new { @class = "text-danger" })
            </div>
          </div>
        }
      } else if (isTextField) { //string, not column and not TextField
        <div class="form-group">
          <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
          <div class="@ViewBag.EditorClass">
            <textarea class="@Aiwe.DH.ControlClasses"
                      rows="@Model.Meta.GetTextFieldRowSize(cn)"                                                
                      name="@cn">@dataValue</textarea> //must be written this way and cannot be auto adjusted. Otherwise the dataValue will be put in the centre of the area (not in the beginning)
            @Html.ValidationMessage(cn, new { @class = "text-danger" })
          </div>
        </div>
      } else { //normal string
        <div class="form-group">
          <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
          <div class="@ViewBag.EditorClass">
            <input type="text" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataValue" />
            @Html.ValidationMessage(cn, new { @class = "text-danger" })
          </div>
        </div>
      }
      Html.RenderPartial("_ForeignInfoCreateEditPart", new ForeignInfoViewModel {
        ColumnName = cn, Value = dataValue,
        PageName = Aibe.DH.CreateEditFilterPageName, DefaultDateTimeFormat = Aiwe.DH.DetailsDateTimeFormat,
        LabelClasses = ViewBag.LabelClasses, EditorClasses = ViewBag.EditorClass,
        BaseModel = Model,
      });
      continue;
    } 
  
    if (Aibe.DH.NumberDataTypes.Contains(dataType)) { //Integer/UInt/Other numbers type
      string dataValue = Model.GetData(cn);                  
      if (Model.ActionType.EqualsIgnoreCase(Aibe.DH.CreateGroupActionName) && Model.Meta.IsAutoGenerated(cn)){
        <input type="hidden" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataValue" />
        continue;
      } 

      if (!isDropDown) { //normal number, use input type = "number"
        <div class="form-group">
          <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
          <div class="@ViewBag.EditorClass">
            <input type="number" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataValue"/>
            @Html.ValidationMessage(cn, new { @class = "text-danger" })
          </div>
        </div>
      } else { //dropdown number
        List<string> dropdowns = Model.Meta.GetStaticCreateEditDropDownFor(cn, dataValue);
        if (dropdowns == null || dropdowns.Count <= 0) {
          <div class="form-group">
            <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
            <div class="@ViewBag.EditorClass">
              <input type="number" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataValue"/>
              @Html.ValidationMessage(cn, new { @class = "text-danger" })
            </div>
          </div>
        } else { //number dropdown case
          <div class="form-group">
            <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
            <div class="@ViewBag.EditorClass">
              <div id="live-dd-@cn" class="live-dd" commondatatype="@Aibe.DH.DropDownNumberDataType">
                @{
                  List<SelectListItem> dropdownItems = new List<SelectListItem> {
                    new SelectListItem { Text = null, Value = null },
                  };
                  dropdownItems.AddRange(dropdowns.Select(x => new SelectListItem { Text = x, Value = x }).ToArray());
                  SelectListItem item = dropdownItems.FirstOrDefault(x => x.Value == dataValue);
                  if (item != null) {
                    item.Selected = true;
                  }
                }
                @Html.DropDownList(cn, dropdownItems, new { @class = Aiwe.DH.ControlClasses + " common-column-dropdown",
                  id = "common-column-dropdown-" + cn })
              </div>
              <input type="text" class="common-column-dropdown-original" id="common-column-dropdown-original-@cn" value="@dataValue" hidden="hidden" />
              @Html.ValidationMessage(cn, new { @class = "text-danger" })
            </div>
          </div>
        }
      }
      Html.RenderPartial("_ForeignInfoCreateEditPart", new ForeignInfoViewModel {
        ColumnName = cn, Value = dataValue,
        PageName = Aibe.DH.CreateEditFilterPageName, DefaultDateTimeFormat = Aiwe.DH.DetailsDateTimeFormat,
        LabelClasses = ViewBag.LabelClasses, EditorClasses = ViewBag.EditorClass,
        BaseModel = Model,
      });
      continue;
    }
                    
    if (dataType.EqualsIgnoreCase(Aibe.DH.DateTimeDataType)) { //DateTime type
      string dataValueRaw = Model.GetData(cn);
      DateTime? dataValueDt = string.IsNullOrWhiteSpace(dataValueRaw) ? null : new DateTime?(DateTime.Parse(dataValueRaw));
      string dataDateValue = dataValueDt.HasValue ? dataValueDt.Value.ToString(Aibe.DH.DefaultDateFormat) : string.Empty;
      string dataTimeName = cn + Aibe.DH.CreateEditTimeAppendixName;
      string dataTimeValue = Model.GetTime(dataTimeName, dataValueDt);

      if (Model.Meta.IsTimeStampAppliedFor(cn, Model.ActionType)) { //if it is timestamp column for the particular column and action, don't use it
        <input type="hidden" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataDateValue" />
        <input type="hidden" name="@dataTimeName" class="@Aiwe.DH.ControlClasses" value="@dataTimeValue" />
        continue;
      }

      <div class="form-group">
        <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
        <div class="@ViewBag.EditorClass">
          <div class="row form-inline" style="margin-left:0px;">
            <input type="date" name="@cn" class="@Aiwe.DH.ControlClasses" value="@dataDateValue"/>
            <input type="time" step="1" name="@dataTimeName" class="@Aiwe.DH.ControlClasses" value="@dataTimeValue"/>
          </div>
          @Html.ValidationMessage(cn, new { @class = "text-danger" })
          @Html.ValidationMessage(dataTimeName, new { @class = "text-danger" })
        </div>
      </div>      
      continue;
    }

    if (dataType.EqualsIgnoreCase(Aibe.DH.BooleanDataType)) {
      string dataValue = Model.GetData(cn);
      List<SelectListItem> dropdownItems = AiweDropDownHelper.GetBooleanOptions();
      SelectListItem item = dropdownItems.FirstOrDefault(x => x.Value.EqualsIgnoreCase(dataValue));
      if (item != null) {
        item.Selected = true;
      }

      <div class="form-group">
        <label class="control-label @ViewBag.LabelClasses">@Model.Meta.GetColumnDisplayName(cn)</label>
        <div class="@ViewBag.EditorClass">          
          @Html.DropDownList(cn, dropdownItems, new { @class = Aiwe.DH.ControlClasses })
          @Html.ValidationMessage(cn, new { @class = "text-danger" })
        </div>
      </div>      
      continue;
    } 

    <p>Name: @Model.Meta.GetColumnDisplayName(cn), Type: @dataType</p>    
  }
  <div id="common-table-name" hidden>@Model.TableName</div>
  <div id="is-first-load" hidden>True</div>
  @Html.ValidationMessage(Aibe.LCZ.I_UnknownColumn, new { @class = "text-danger" })
</div>
